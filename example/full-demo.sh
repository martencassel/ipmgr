#!/usr/bin/env bash
set -e

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ipmgr + kind + Docker Compose Full Demo     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

IFACE="${IFACE:-docker0}"
POOL="${POOL:-172.21.22.160-172.21.22.170}"

# Step 1: Allocate IPs for nginx containers
echo "ğŸ“ Step 1: Allocating IPs for Nginx containers"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
for i in {1..3}; do
    ../ipmgr alloc --pool "$POOL" --iface "$IFACE"
done

echo ""
echo "ğŸ“ Generating .env file for Docker Compose..."
../ipmgr render-env --iface "$IFACE" --prefix DEMO > .env

cat .env
echo ""

# Step 2: Start nginx containers
echo "ğŸ³ Step 2: Starting Nginx containers"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
docker-compose up -d

echo ""
sleep 2

# Step 3: Setup kind cluster
echo "ğŸš€ Step 3: Setting up kind cluster"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
./setup-kind.sh

echo ""
sleep 2

# Step 4: Show all allocations
echo "ğŸ“Š Step 4: Current IP Allocations"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
../ipmgr list-all

echo ""

# Step 5: Test connectivity
echo "ğŸ” Step 5: Testing Connectivity"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
./test-connectivity.sh

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… Demo Complete!                            â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "You now have:"
echo "  â€¢ 3 Nginx containers on dedicated IPs"
echo "  â€¢ 1 kind Kubernetes cluster on a dedicated IP"
echo "  â€¢ All IPs managed by ipmgr"
echo ""
echo "To clean up everything, run:"
echo "  ./cleanup-all.sh"
echo ""
